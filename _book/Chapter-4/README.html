<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>操作系统的主干和C++运行时 | 如何做一个计算机操作系统</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="这是一本介绍用C/C++从零开始写一个操作系统的在线书籍">
        <meta name="keywords" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="../Chapter-5/README.html" />
    
    
    <link rel="prev" href="../Chapter-3/README.html" />
    

        
    </head>
    <body>
        
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
    

        
    <div class="book" data-level="4" data-basepath=".." data-revision="1425819891260">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         介绍
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="Chapter-1/README.html">
            
                
                    <a href="../Chapter-1/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         介绍x86体系结构和我们的操作系统
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="Chapter-2/README.html">
            
                
                    <a href="../Chapter-2/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         建立开发环境
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="Chapter-3/README.html">
            
                
                    <a href="../Chapter-3/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         GRUB的初次启动
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="4" data-path="Chapter-4/README.html">
            
                
                    <a href="../Chapter-4/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         操作系统的主干和C++运行时
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="Chapter-5/README.html">
            
                
                    <a href="../Chapter-5/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         管理x86体系结构的基础类
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="Chapter-6/README.html">
            
                
                    <a href="../Chapter-6/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         GDT
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="Chapter-7/README.html">
            
                
                    <a href="../Chapter-7/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         IDT和中断
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="8" data-path="Chapter-8/README.html">
            
                
                    <a href="../Chapter-8/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                         内存管理:物理内存和虚存
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
    	
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header clearfix">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right weibo-sharing-link sharing-link" data-sharing="weibo" aria-label="Share on Weibo"><i class="fa fa-weibo"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right qq-sharing-link sharing-link" data-sharing="qq" aria-label="Share on QQ"><i class="fa fa-qq"></i></a>
    
    
    <div class="dropdown pull-right">
        <a href="#" class="btn qrcode-toggle-dropdown qrcode-sharing-link sharing-link" data-sharing="qrcode"  aria-label="Share on QRCode"><i class="fa fa-qrcode"></i></a>
        <div class="dropdown-menu font-settings dropdown-left" id="dropdown-qrcode">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="qrcode" id="qrcode">
                <input type="hidden" name="last_url" id="last_url" value="" />
            </div>
        </div>
    </div>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >如何做一个计算机操作系统</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_328">
                    
                        <h2 id="-c">第四章: 操作系统的主干和C++运行时</h2>
<h4 id="c-kernel">C++ kernel运行时</h4>
<p>内核可以用c++编程, 它非常类似于用C做一个内核, 但是有几个陷阱你必须考虑(运行时支持, 构造函数…). </p>
<p>编译器假定所有必要的c++运行时支持都是默认可用的, 但因为我们不连接libsupc++到c++的内核, 所以我们需要添加一些基本功能, 这可以在<a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/cxx.cc" target="_blank">cxx.cc</a>中找到. </p>
<p><strong>注意:</strong> 在初始化虚存和分页之前, 不能使用操作子 <code>new</code> 和 <code>delete</code>. </p>
<h4 id="cc">基本的C/C++函数</h4>
<p>内核代码不能使用标准库函数,所以我们需要添加一些基本函数用于管理内存和字符串:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">void</span>     itoa(<span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> base);

<span class="hljs-keyword">void</span> *    <span class="hljs-built_in">memset</span>(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">char</span> src, <span class="hljs-keyword">int</span> n);
<span class="hljs-keyword">void</span> *    <span class="hljs-built_in">memcpy</span>(<span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src, <span class="hljs-keyword">int</span> n);

<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strlen</span>(<span class="hljs-keyword">char</span> *s);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strcmp</span>(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dst, <span class="hljs-keyword">char</span> *src);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strcpy</span>(<span class="hljs-keyword">char</span> *dst,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *src);
<span class="hljs-keyword">void</span>     <span class="hljs-built_in">strcat</span>(<span class="hljs-keyword">void</span> *dest,<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *src);
<span class="hljs-keyword">char</span> *    <span class="hljs-built_in">strncpy</span>(<span class="hljs-keyword">char</span> *destString, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sourceString,<span class="hljs-keyword">int</span> maxLength);
<span class="hljs-keyword">int</span>     <span class="hljs-built_in">strncmp</span>( <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* s2, <span class="hljs-keyword">int</span> c );
</code></pre>
<p>这些函数定义在<a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/string.cc" target="_blank">string.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/memory.cc" target="_blank">memory.cc</a>, <a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/runtime/itoa.cc" target="_blank">itoa.cc</a>中. </p>
<h4 id="c">C数据类型</h4>
<p>在接下来的步骤中,我们将在我们的代码中使用不同类型, 我们将使用的大部分的类型是无符号类型(所有的位都用于存储整数, 在有符号类型中有一位用于符号标记):</p>
<p>During the next step, we are going to use different types in our code, most of the types we are going to use unsigned types (all the bits are used to stored the integer, in signed types one bit is used to signal the sign):</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>     u8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span>     u16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>     u32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>     u64;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">char</span>     s8;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">short</span>     s16;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">int</span>         s32;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">signed</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>    s64;
</code></pre>
<h4 id="">编译内核</h4>
<p>编译内核不同于编译linux可执行文件, 我们不能使用标准库, 并且应该独立于系统. </p>
<p>我们的<a href="https://github.com/SamyPesse/How-to-Make-a-Computer-Operating-System/blob/master/src/kernel/Makefile" target="_blank">Makefile</a>将定义编译和链接我们的操作系统的过程. </p>
<p>对于x86体系结构, gcc/g++/ld会使用下面这些参数: </p>
<pre><code class="lang-makefile"><span class="hljs-comment"># Linker</span>
<span class="hljs-constant">LD</span>=ld
<span class="hljs-constant">LDFLAG</span>= -melf_i386 -static  -L ./  -T ./arch/<span class="hljs-variable">$(ARCH)</span>/linker.ld

<span class="hljs-comment"># C++ compiler</span>
<span class="hljs-constant">SC</span>=g++
<span class="hljs-constant">FLAG</span>= <span class="hljs-variable">$(INCDIR)</span> -g -O2 -w -trigraphs -fno-builtin  -fno-exceptions -fno-stack-protector -O0 -m32  -fno-rtti -nostdlib -nodefaultlibs 

<span class="hljs-comment"># Assembly compiler</span>
<span class="hljs-constant">ASM</span>=nasm
<span class="hljs-constant">ASMFLAG</span>=-f elf -o
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Chapter-3/README.html" class="navigation navigation-prev " aria-label="Previous page: GRUB的初次启动"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Chapter-5/README.html" class="navigation navigation-next " aria-label="Next page: 管理x86体系结构的基础类"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-ga/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-duoshuo/duoshuo.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":"white","family":"serif","size":2},"ga":{"token":"UA-39088953-8","configuration":"auto"},"duoshuo":{"short_name":"wiznote","theme":"default"}};
    gitbook.start(config);
});
</script>

        <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-39088953-8', 'auto');ga('send', 'pageview');</script>
    </body>
    
</html>
